# 3Dフレーム解析プログラム - 部材途中変形表示機能 実装ノート

## 実装日
2025年10月4日

## 実装内容

### 1. 部材途中の変形計算関数（`calculateMemberDeformation`）
**ファイル**: `new_displacement_diagram.js`

#### 機能概要
- 部材を分割し、任意の位置での変形を計算
- 3Dフレームに対応（6自由度/節点）
- 曲げモーメントによるたわみを考慮（エルミート補間使用）

#### 主要パラメータ
- `member`: 部材オブジェクト
- `nodes`: 節点配列
- `D_global`: 全体変位ベクトル
- `memberForces`: 部材力配列
- `xi`: 部材長さ方向の無次元座標 (0.0 ~ 1.0)
- `dispScale`: 変位の拡大倍率

#### 実装の詳細
1. **節点変位の取得**: 部材の両端節点（i, j）の変位（dx, dy, dz）と回転（rx, ry, rz）を取得
2. **エルミート基底関数**: 
   - H1 = 1 - 3x² + 2x³
   - H2 = x - 2x² + x³
   - H3 = 3x² - 2x³
   - H4 = -x² + x³
3. **曲げ変形の計算**:
   - Y方向の曲げ = H1×0 + H2×L×rz_i + H3×0 + H4×L×rz_j
   - Z方向の曲げ = H1×0 + H2×L×(-ry_i) + H3×0 + H4×L×(-ry_j)
4. **合成変位**: 並進変位 + 曲げ変形

### 2. 部材途中の曲げモーメント計算関数（`calculateMemberMoment`）
**ファイル**: `new_displacement_diagram.js`

#### 機能概要
- 部材の任意の位置での曲げモーメントを計算
- 3D対応（My, Mz軸別）

#### 計算方法
- 線形補間: M(xi) = M_i + (M_j - M_i) × xi
- 等分布荷重がある場合は二次曲線になるが、簡易版として線形補間を使用

### 3. 部材途中のせん断力計算関数（`calculateMemberShear`）
**ファイル**: `new_displacement_diagram.js`

#### 機能概要
- 部材の任意の位置でのせん断力を計算
- 3D対応（Qy, Qz方向別）

#### 計算方法
- 等分布荷重がない場合、せん断力は一定（始端値を使用）

### 4. 変形図描画の改良
**ファイル**: `new_displacement_diagram.js` - `drawDisplacementDiagram`関数

#### 改良点
1. **分割数の増加**: 10分割 → 20分割（より滑らかな曲線）
2. **曲げ変形の考慮**: `calculateMemberDeformation`関数を使用
3. **3D/2D両対応**: 自由度数から自動判定

#### 描画の流れ
```javascript
for (let k = 0; k <= 20; k++) {
    const xi = k / 20;
    const deformed = calculateMemberDeformation(m, nodes, D_global, memberForces, xi, dispScale);
    // 投影して描画
}
```

### 5. 応力図描画の改良
**ファイル**: `new_displacement_diagram.js` - `drawStressDiagram`関数

#### 改良点
1. **部材途中の応力値計算**: 20分割して各点での応力を計算
2. **最大応力位置の表示**: 部材端以外での最大値もマーカー表示
3. **滑らかな応力図**: 多数のセグメントで塗りつぶし

#### 描画の流れ
```javascript
// 部材を20分割
for (let k = 0; k <= 20; k++) {
    const xi = k / 20;
    // 応力タイプに応じて計算
    if (stressType === 'moment') {
        stressValue = calculateMemberMoment(forces, L, xi, axis);
    } else if (stressType === 'shear') {
        stressValue = calculateMemberShear(forces, L, xi, axis);
    }
    stressPoints.push({x, y, value, offset});
}

// セグメントごとに塗りつぶし
for (let k = 0; k < 20; k++) {
    // 応力図を描画
}

// 最大応力位置を表示
```

## 技術的なポイント

### エルミート補間の採用理由
- 節点での変位だけでなく、回転角（傾き）も考慮できる
- 曲げモーメントによる滑らかなたわみ曲線を表現可能
- 3次多項式により、境界条件を満たす

### 投影面の対応
- **XY平面**: 水平面を上から見た図（Z軸周りモーメント、Z方向せん断力）
- **XZ平面**: X方向鉛直断面（Y軸周りモーメント、Z方向せん断力）
- **YZ平面**: Y方向鉛直断面（X軸周りモーメント、Y方向せん断力）

### 応力値の符号規則
- **正の値**: 赤色で表示（引張、正の曲げモーメント）
- **負の値**: 青色で表示（圧縮、負の曲げモーメント）

## 使用方法

### 変形図の表示
1. 構造モデルを作成
2. 解析を実行
3. 変形図キャンバスに自動的に描画される
4. 変位倍率スライダーで拡大率を調整可能

### 応力図の表示
1. 解析実行後、自動的に各応力図が描画される
2. 曲げモーメント図、せん断力図、軸力図が別々のキャンバスに表示
3. 各構面（XY, XZ, YZ）ごとに横スクロールで表示

## 今後の拡張可能性

1. **等分布荷重の考慮**: 部材途中での二次曲線的な応力分布
2. **ねじりモーメントの表示**: Mx, T（ねじり）の3D表示
3. **断面力の合成表示**: 複数の応力を同時に表示
4. **アニメーション**: 変形過程を時系列で表示
5. **3Dビューアとの連携**: 3D空間での変形・応力表示

## 参考にした2Dプログラムとの違い

### 2Dプログラム
- 単一平面での解析
- 3自由度/節点（dx, dy, rz）
- 1つの曲げモーメント（M）、1つのせん断力（Q）

### 3Dプログラム（本実装）
- 複数投影面での表示（XY, XZ, YZ）
- 6自由度/節点（dx, dy, dz, rx, ry, rz）
- 3つの曲げモーメント（Mx, My, Mz）、2つのせん断力（Qy, Qz）
- 各投影面に適切な応力成分を自動選択

## テスト推奨項目

- [ ] 単純梁の変形（理論値との比較）
- [ ] 片持ち梁の変形（最大たわみ位置の確認）
- [ ] ラーメン構造の変形
- [ ] 曲げモーメント最大値位置の表示
- [ ] 複数構面を持つ3D構造での表示
- [ ] 変位倍率変更時の動作

## バージョン情報
- 実装バージョン: v1.0
- 対応3Dライブラリ: Three.js r128
- ブラウザ要件: HTML5 Canvas対応
